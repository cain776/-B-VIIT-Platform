<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 관리 - EyeChartPro Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="../js/supabase-config.js"></script>
    <style>
        /* Code badge */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-badge.super_admin {
            background: #4f46e5;
            color: white;
        }

        .role-badge.admin_master {
            background: #7c3aed;
            color: white;
        }

        .role-badge.admin_staff {
            background: #a78bfa;
            color: white;
        }

        .role-badge.hospital_master {
            background: #10b981;
            color: white;
        }

        .role-badge.hospital_staff {
            background: #6ee7b7;
            color: #065f46;
        }

        /* Status badge */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.pending {
            background: #ffedd5;
            color: #ea580c;
        }

        .status-badge.approved {
            background: #d1fae5;
            color: #059669;
        }

        .status-badge.rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Floating Label Styles */
        .floating-group {
            position: relative;
            margin-bottom: 20px;
        }

        .floating-group input,
        .floating-group select {
            width: 100%;
            padding: 22px 14px 8px;
            font-size: 14px;
            color: #1e293b;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            outline: none;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .floating-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px;
            cursor: pointer;
        }

        .floating-group input:hover,
        .floating-group select:hover {
            border-color: #cbd5e1;
            background-color: #f1f5f9;
        }

        .floating-group input:focus,
        .floating-group select:focus {
            border-color: #3b82f6;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .floating-group label {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 13px;
            pointer-events: none;
            transition: all 0.2s ease;
            background: transparent;
        }

        .floating-group.has-value label,
        .floating-group input:focus+label,
        .floating-group select:focus+label,
        .floating-group input:not(:placeholder-shown)+label {
            top: 10px;
            transform: translateY(0);
            font-size: 11px;
            color: #3b82f6;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 540px;
            max-width: 95vw;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            background: #2563eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 28px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .modal-body {
            padding: 28px;
            overflow-y: auto;
            max-height: calc(90vh - 180px);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 20px 28px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .modal-footer-left {
            display: flex;
            gap: 8px;
        }

        .modal-footer-right {
            display: flex;
            gap: 12px;
        }

        .btn-cancel {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            border: 1px solid #e5e7eb;
            color: #374151;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: #f3f4f6;
        }

        .btn-submit {
            padding: 12px 32px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            border: 2px solid #2563eb;
            color: #2563eb;
            transition: all 0.2s;
        }

        .btn-submit:hover {
            background: #2563eb;
            color: white;
            transform: translateY(-1px);
        }

        .btn-approve {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: #10b981;
            border: 1.5px solid #10b981;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-approve:hover {
            background: #10b981;
            color: white;
        }

        .btn-reject {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: #ef4444;
            border: 1.5px solid #ef4444;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-reject:hover {
            background: #ef4444;
            color: white;
        }

        /* Current Status Badge in Modal */
        .current-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .current-status-label {
            font-size: 13px;
            color: #6b7280;
        }

        .current-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .current-status-badge.pending {
            background: #fff7ed;
            color: #ea580c;
        }

        .current-status-badge.approved {
            background: #ecfdf5;
            color: #059669;
        }

        .current-status-badge.rejected {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #6b7280;
        }

        .empty-state i {
            color: #d1d5db;
            margin-bottom: 16px;
        }

        /* Action buttons */
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        /* Status action buttons */
        .status-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="sidebar-container"></div>
    <div id="topbar-container"></div>

    <main class="main-content p-6">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-xl font-bold text-gray-900">회원 관리</h1>
                <p class="text-sm text-gray-500 mt-1">등록된 운영 회원을 관리하고 승인합니다</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-5 gap-5 mb-6">
            <div class="stat-card">
                <div class="stat-icon purple">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statTotal">0</span>
                    <span class="stat-label">전체 회원</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i data-lucide="clock" class="w-5 h-5"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statPending">0</span>
                    <span class="stat-label">승인 대기</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statApproved">0</span>
                    <span class="stat-label">승인 완료</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">
                    <i data-lucide="x-circle" class="w-5 h-5"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statRejected">0</span>
                    <span class="stat-label">거부됨</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i data-lucide="building-2" class="w-5 h-5"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="statHospitalUsers">0</span>
                    <span class="stat-label">병원 소속</span>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="card">
            <div class="card-header flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <h2 class="text-base font-semibold text-gray-900">등록된 회원 목록</h2>
                    <span class="text-sm text-gray-400" id="resultCount">(검색 결과: 0건)</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="search-box">
                        <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="이름 또는 이메일로 검색..." oninput="filterUsers()">
                    </div>
                    <select id="statusFilter" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        onchange="filterUsers()">
                        <option value="">전체 상태</option>
                        <option value="pending">승인 대기</option>
                        <option value="approved">승인 완료</option>
                        <option value="rejected">거부됨</option>
                    </select>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>이름</th>
                        <th>아이디(이메일)</th>
                        <th>전화번호</th>
                        <th>부서</th>
                        <th>직위</th>
                        <th>권한</th>
                        <th>소속</th>
                        <th>상태</th>
                        <th>등록일</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="11" class="empty-state">
                            <i data-lucide="users" class="w-12 h-12 mx-auto"></i>
                            <p>등록된 회원이 없습니다.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- User Edit Modal -->
    <div id="userModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">회원 정보 수정</h3>
                <button class="modal-close" onclick="closeUserModal()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="return false;">
                    <input type="hidden" id="userId">

                    <!-- Current Status -->
                    <div class="current-status">
                        <span class="current-status-label">현재 상태</span>
                        <span class="current-status-badge pending" id="currentStatusBadge">● 승인 대기</span>
                    </div>

                    <div class="form-row">
                        <div class="floating-group has-value">
                            <input type="text" id="userName" placeholder=" ">
                            <label>이름</label>
                        </div>
                        <div class="floating-group has-value">
                            <input type="email" id="userEmail" placeholder=" " disabled>
                            <label>이메일</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="floating-group has-value">
                            <select id="userRole">
                                <option value="hospital_staff">병원 스태프</option>
                                <option value="hospital_master">병원 마스터</option>
                                <option value="admin_staff">어드민 스태프</option>
                                <option value="admin_master">어드민 마스터</option>
                                <option value="super_admin">슈퍼 관리자</option>
                            </select>
                            <label>권한</label>
                        </div>
                        <div class="floating-group has-value">
                            <select id="userHospital">
                                <option value="">소속 선택</option>
                            </select>
                            <label>소속</label>
                        </div>
                    </div>

                    <div class="floating-group has-value">
                        <input type="text" id="userPhone" placeholder=" ">
                        <label>연락처</label>
                    </div>

                    <div class="form-row">
                        <div class="floating-group has-value">
                            <select id="userDepartment">
                                <option value="">부서 선택</option>
                                <option value="연구개발팀">연구개발팀</option>
                                <option value="경영기획팀">경영기획팀</option>
                                <option value="마케팅팀">마케팅팀</option>
                                <option value="콘텐츠팀">콘텐츠팀</option>
                                <option value="DX팀">DX팀</option>
                                <option value="CQO팀">CQO팀</option>
                                <option value="전산정보팀">전산정보팀</option>
                            </select>
                            <label>부서</label>
                        </div>
                        <div class="floating-group has-value">
                            <select id="userJobTitle">
                                <option value="">직위 선택</option>
                                <option value="매니저">매니저</option>
                                <option value="어쏘">어쏘</option>
                                <option value="리드">리드</option>
                                <option value="디렉터">디렉터</option>
                                <option value="대리">대리</option>
                            </select>
                            <label>직위</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button type="button" class="btn-approve" onclick="updateUserStatus('approved')">
                        <i data-lucide="check" class="w-4 h-4"></i> 승인
                    </button>
                    <button type="button" class="btn-reject" onclick="updateUserStatus('rejected')">
                        <i data-lucide="x" class="w-4 h-4"></i> 거부
                    </button>
                </div>
                <div class="modal-footer-right">
                    <button class="btn-cancel" onclick="closeUserModal()">취소</button>
                    <button class="btn-submit" id="submitBtn" onclick="saveUser()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/admin-sidebar.js"></script>
    <script src="../js/admin-topbar.js"></script>
    <script>
        let users = [];
        let hospitals = [];
        let supabaseClient = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await initSupabaseClient();
            await loadHospitals();
            await loadUsers();
        });

        // Initialize Supabase
        async function initSupabaseClient() {
            const SUPABASE_URL = 'https://txzcmvoknooiejwkprje.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4emNtdm9rbm9vaWVqd2twcmplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTAxMDksImV4cCI6MjA4MzQ4NjEwOX0.WXSm7pW9sCXzioGczZvE_eQsvcYyVkB1ogCyk0dVtFk';
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Load hospitals for dropdown
        async function loadHospitals() {
            try {
                const { data, error } = await supabaseClient
                    .from('hospitals')
                    .select('id, name, code')
                    .order('name');

                if (error) throw error;
                hospitals = data || [];
                updateHospitalOptions();
            } catch (err) {
                console.error('병원 목록 조회 오류:', err);
            }
        }

        // Update hospital dropdown options
        function updateHospitalOptions() {
            const select = document.getElementById('userHospital');
            select.innerHTML = '<option value="">소속 선택</option>' +
                hospitals.map(h => `<option value="${h.id}">${h.name} (${h.code})</option>`).join('');
        }

        // Load users
        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select(`
                        id,
                        email,
                        name,
                        phone,
                        department,
                        job_title,
                        role,
                        hospital_id,
                        status,
                        created_at,
                        updated_at
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Map hospital names
                users = (data || []).map(user => ({
                    ...user,
                    hospital_name: hospitals.find(h => h.id === user.hospital_id)?.name || '-'
                }));

                renderUsers();
                updateStats();
            } catch (err) {
                console.error('회원 목록 조회 오류:', err);
            }
        }

        // Get role display name
        function getRoleName(role) {
            const roleMap = {
                'super_admin': '슈퍼유저',
                'admin_master': '어드민 마스터',
                'admin_staff': '어드민 스태프',
                'hospital_master': '병원 마스터',
                'hospital_staff': '병원 스태프'
            };
            return roleMap[role] || role;
        }

        // Get status display name
        function getStatusName(status) {
            const statusMap = {
                'pending': '승인 대기',
                'approved': '승인됨',
                'rejected': '거부됨'
            };
            return statusMap[status] || status;
        }

        // Render users table
        function renderUsers(filteredData = null) {
            const tbody = document.getElementById('userTableBody');
            const data = filteredData || users;

            document.getElementById('resultCount').textContent = `(검색 결과: ${data.length}건)`;

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="empty-state">
                            <i data-lucide="users" class="w-12 h-12 mx-auto"></i>
                            <p>등록된 회원이 없습니다.</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = data.map((user, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td class="font-semibold text-gray-900">${user.name || '-'}</td>
                    <td class="text-gray-600">${user.email}</td>
                    <td class="text-gray-600">${user.phone || '-'}</td>
                    <td class="text-gray-600">${user.department || '-'}</td>
                    <td class="text-gray-600">${user.job_title || '-'}</td>
                    <td>
                        <span class="role-badge ${user.role}">
                            ${getRoleName(user.role)}
                        </span>
                    </td>
                    <td>${user.hospital_name}</td>
                    <td>
                        <span class="status-badge ${user.status}">
                            ● ${getStatusName(user.status)}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td class="actions">
                        <button class="action-btn" onclick="editUser('${user.id}')" title="수정">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        // Update stats
        function updateStats() {
            document.getElementById('statTotal').textContent = users.length;
            document.getElementById('statPending').textContent = users.filter(u => u.status === 'pending').length;
            document.getElementById('statApproved').textContent = users.filter(u => u.status === 'approved').length;
            document.getElementById('statRejected').textContent = users.filter(u => u.status === 'rejected').length;
            document.getElementById('statHospitalUsers').textContent = users.filter(u => u.hospital_id).length;
        }

        // Filter users
        function filterUsers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = users;

            if (query) {
                filtered = filtered.filter(u =>
                    (u.name && u.name.toLowerCase().includes(query)) ||
                    u.email.toLowerCase().includes(query)
                );
            }

            if (statusFilter) {
                filtered = filtered.filter(u => u.status === statusFilter);
            }

            renderUsers(filtered);
        }

        // Edit user
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userHospital').value = user.hospital_id || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userDepartment').value = user.department || '';
            document.getElementById('userJobTitle').value = user.job_title || '';

            // Update current status badge
            const statusBadge = document.getElementById('currentStatusBadge');
            statusBadge.className = 'current-status-badge ' + user.status;
            statusBadge.textContent = '● ' + getStatusName(user.status);

            document.getElementById('modalTitle').textContent = '회원 정보 수정';

            const modal = document.getElementById('userModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        // Close modal
        function closeUserModal() {
            const modal = document.getElementById('userModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Save user
        async function saveUser() {
            const id = document.getElementById('userId').value;
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;
            const hospitalId = document.getElementById('userHospital').value || null;
            const phone = document.getElementById('userPhone').value.trim();
            const department = document.getElementById('userDepartment').value.trim();
            const jobTitle = document.getElementById('userJobTitle').value.trim();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '저장 중...';

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        name: name || null,
                        role,
                        hospital_id: hospitalId,
                        phone,
                        department: department || null,
                        job_title: jobTitle || null
                    })
                    .eq('id', id);

                if (error) throw error;

                closeUserModal();
                await loadUsers();

                // 상단 프로필도 새로고침
                if (typeof loadCurrentUserProfile === 'function') {
                    loadCurrentUserProfile();
                }
            } catch (err) {
                console.error('저장 오류:', err);
                alert('저장 중 오류가 발생했습니다: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '저장';
            }
        }

        // Update user status (approve/reject)
        async function updateUserStatus(newStatus) {
            const id = document.getElementById('userId').value;

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ status: newStatus })
                    .eq('id', id);

                if (error) throw error;

                closeUserModal();
                await loadUsers();
            } catch (err) {
                console.error('상태 변경 오류:', err);
                alert('상태 변경 중 오류가 발생했습니다: ' + err.message);
            }
        }

        // Close modal on overlay click
        document.getElementById('userModal').addEventListener('click', function (e) {
            if (e.target === this) closeUserModal();
        });

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }
    </script>
</body>

</html>